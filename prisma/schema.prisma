generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Veículos no estoque
model Vehicle {
  id          String   @id @default(uuid())
  marca       String
  modelo      String
  versao      String?
  ano         Int
  km          Int
  preco       Float
  cor         String
  carroceria  String   // hatch, sedan, SUV, picape
  combustivel String   @default("Flex")
  cambio      String   @default("Manual")
  
  // Opcionais básicos
  arCondicionado     Boolean @default(false)
  direcaoHidraulica  Boolean @default(false)
  airbag            Boolean @default(false)
  abs               Boolean @default(false)
  
  // Opcionais adicionais
  vidroEletrico     Boolean @default(false)
  travaEletrica     Boolean @default(false)
  alarme            Boolean @default(false)
  rodaLigaLeve      Boolean @default(false)
  som               Boolean @default(false)
  portas            Int     @default(4)
  
  // Mídia
  fotoUrl       String?
  fotosUrls     String   @default("") // JSON string array
  
  // URL do veículo no site da loja
  url           String?
  
  // Descrição
  descricao     String?
  
  // Embedding vetorial (OpenAI text-embedding-3-small - 1536 dimensões)
  embedding     String?  // JSON array de números
  embeddingModel String? @default("text-embedding-3-small")
  embeddingGeneratedAt DateTime?
  
  // Status
  disponivel    Boolean  @default(true)
  
  // Contextos de uso
  aptoUber      Boolean  @default(false)  // Apto para Uber/99/apps
  aptoUberBlack Boolean  @default(false)  // Apto para Uber Black
  aptoFamilia   Boolean  @default(true)   // Recomendado para família
  aptoTrabalho  Boolean  @default(true)   // Bom para trabalho/cidade
  economiaCombustivel String? // baixa, media, alta
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  recommendations Recommendation[]
  leads           Lead[]
}

// Conversas no WhatsApp
model Conversation {
  id              String   @id @default(uuid())
  phoneNumber     String
  customerName    String?
  
  // Estado da conversa
  status          String   @default("active") // active, qualified, converted, abandoned
  currentStep     String   @default("greeting") // greeting, quiz, recommendation, closed
  
  // Dados do quiz (JSON as string)
  quizAnswers     String?
  profileData     String?
  
  // Timestamps
  startedAt       DateTime @default(now())
  lastMessageAt   DateTime @default(now())
  closedAt        DateTime?
  
  // Relations
  events          Event[]
  messages        Message[]
  recommendations Recommendation[]
  leads           Lead[]
}

// Eventos/Actions na conversa
model Event {
  id              String   @id @default(uuid())
  conversationId  String
  eventType       String   // started, quiz_question, quiz_completed, recommendation_sent, visit_scheduled, sold
  metadata        String?
  timestamp       DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([eventType])
  @@index([timestamp])
}

// Recomendações geradas
model Recommendation {
  id              String   @id @default(uuid())
  conversationId  String
  vehicleId       String
  
  matchScore      Int      // 0-100
  reasoning       String   // Justificativa da recomendação
  position        Int      @default(1) // 1, 2, 3 (top 3)
  
  // Cliente interagiu?
  clicked         Boolean  @default(false)
  interested      Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  vehicle         Vehicle      @relation(fields: [vehicleId], references: [id])
  
  @@index([conversationId])
  @@index([matchScore])
}

// Leads qualificados para encaminhamento ao vendedor
model Lead {
  id                  String   @id @default(uuid())
  
  // Dados do cliente
  customerName        String
  customerPhone       String
  
  // Veículo de interesse
  vehicleId           String
  vehicleMarca        String
  vehicleModelo       String
  vehicleAno          Int
  vehiclePreco        Float
  vehicleUrl          String?
  
  // Contexto da conversa
  conversationId      String?
  conversationSummary String?
  customerPreferences String?  // JSON string of CustomerProfile
  
  // Status do lead: pending, sent, failed, contacted
  status              String   @default("pending")
  sentAt              DateTime?
  contactedAt         DateTime?
  
  // Número do vendedor que recebeu o lead
  sellerPhone         String
  
  // Timestamps
  capturedAt          DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  vehicle             Vehicle      @relation(fields: [vehicleId], references: [id])
  conversation        Conversation? @relation(fields: [conversationId], references: [id])
  
  @@index([customerPhone])
  @@index([status])
  @@index([capturedAt])
  @@index([vehicleId])
}

// Mensagens (log opcional)
model Message {
  id              String   @id @default(uuid())
  conversationId  String
  
  direction       String   // incoming, outgoing
  content         String
  messageType     String   @default("text") // text, image, button
  
  // WhatsApp metadata
  waMessageId     String?
  
  timestamp       DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([timestamp])
}
