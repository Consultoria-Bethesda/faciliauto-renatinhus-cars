generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Concessionária (Multi-tenant)
model Dealership {
  id              String   @id @default(uuid())
  name            String   // "Renatinhu's Cars"
  cnpj            String   @unique
  websiteUrl      String   // "https://www.renatinhuscars.com.br/"
  logoUrl         String?
  sellerWhatsApp  String   // Número do vendedor
  isActive        Boolean  @default(true)
  
  // Commission configuration
  commissionType  String   @default("percentage") // "percentage" | "fixed"
  commissionRate  Float    @default(2.0)          // 2% default or fixed value in BRL
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  vehicles        Vehicle[]
  leads           Lead[]
  users           User[]
  conversations   Conversation[]
}

// Usuário do Dashboard
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          String    @default("seller") // "admin" | "seller" | "partner"
  dealershipId  String?   // null for admin/partner (access to all)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  dealership    Dealership? @relation(fields: [dealershipId], references: [id])
  leadEvents    LeadEvent[]
  
  @@index([email])
  @@index([role])
}

// Veículos no estoque
model Vehicle {
  id          String   @id @default(uuid())
  marca       String
  modelo      String
  versao      String?
  ano         Int
  km          Int
  preco       Float
  cor         String
  carroceria  String   // hatch, sedan, SUV, picape
  combustivel String   @default("Flex")
  cambio      String   @default("Manual")
  
  // Multi-tenant
  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])
  
  // Opcionais básicos
  arCondicionado     Boolean @default(false)
  direcaoHidraulica  Boolean @default(false)
  airbag            Boolean @default(false)
  abs               Boolean @default(false)
  
  // Opcionais adicionais
  vidroEletrico     Boolean @default(false)
  travaEletrica     Boolean @default(false)
  alarme            Boolean @default(false)
  rodaLigaLeve      Boolean @default(false)
  som               Boolean @default(false)
  portas            Int     @default(4)
  
  // Mídia
  fotoUrl       String?
  fotosUrls     String   @default("") // JSON string array
  
  // URL do veículo no site da loja
  url           String?
  
  // Descrição
  descricao     String?
  
  // Embedding vetorial (OpenAI text-embedding-3-small - 1536 dimensões)
  embedding     String?  // JSON array de números
  embeddingModel String? @default("text-embedding-3-small")
  embeddingGeneratedAt DateTime?
  
  // Status
  disponivel    Boolean  @default(true)
  
  // Contextos de uso
  aptoUber      Boolean  @default(false)  // Apto para Uber/99/apps
  aptoUberBlack Boolean  @default(false)  // Apto para Uber Black
  aptoFamilia   Boolean  @default(true)   // Recomendado para família
  aptoTrabalho  Boolean  @default(true)   // Bom para trabalho/cidade
  economiaCombustivel String? // baixa, media, alta
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  recommendations Recommendation[]
  leads           Lead[]
}

// Conversas no WhatsApp
model Conversation {
  id              String   @id @default(uuid())
  phoneNumber     String
  customerName    String?
  
  // Multi-tenant
  dealershipId    String?
  dealership      Dealership? @relation(fields: [dealershipId], references: [id])
  
  // Estado da conversa
  status          String   @default("active") // active, qualified, converted, abandoned
  currentStep     String   @default("greeting") // greeting, quiz, recommendation, closed
  
  // Dados do quiz (JSON as string)
  quizAnswers     String?
  profileData     String?
  
  // Timestamps
  startedAt       DateTime @default(now())
  lastMessageAt   DateTime @default(now())
  closedAt        DateTime?
  
  // Relations
  events          Event[]
  messages        Message[]
  recommendations Recommendation[]
  leads           Lead[]
  
  @@index([dealershipId])
}

// Eventos/Actions na conversa
model Event {
  id              String   @id @default(uuid())
  conversationId  String
  eventType       String   // started, quiz_question, quiz_completed, recommendation_sent, visit_scheduled, sold
  metadata        String?
  timestamp       DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([eventType])
  @@index([timestamp])
}

// Recomendações geradas
model Recommendation {
  id              String   @id @default(uuid())
  conversationId  String
  vehicleId       String
  
  matchScore      Int      // 0-100
  reasoning       String   // Justificativa da recomendação
  position        Int      @default(1) // 1, 2, 3 (top 3)
  
  // Cliente interagiu?
  clicked         Boolean  @default(false)
  interested      Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  vehicle         Vehicle      @relation(fields: [vehicleId], references: [id])
  
  @@index([conversationId])
  @@index([matchScore])
}

// Leads qualificados para encaminhamento ao vendedor
model Lead {
  id                  String   @id @default(uuid())
  
  // Multi-tenant
  dealershipId        String?
  dealership          Dealership? @relation(fields: [dealershipId], references: [id])
  
  // Dados do cliente
  customerName        String
  customerPhone       String
  
  // Veículo de interesse
  vehicleId           String
  vehicleMarca        String
  vehicleModelo       String
  vehicleAno          Int
  vehiclePreco        Float
  vehicleUrl          String?
  
  // Contexto da conversa
  conversationId      String?
  conversationSummary String?
  customerPreferences String?  // JSON string of CustomerProfile
  
  // Status do lead: pending, sent, failed, contacted, converted, lost
  status              String   @default("pending")
  sentAt              DateTime?
  contactedAt         DateTime?
  
  // Número do vendedor que recebeu o lead
  sellerPhone         String
  
  // Timestamps
  capturedAt          DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  vehicle             Vehicle      @relation(fields: [vehicleId], references: [id])
  conversation        Conversation? @relation(fields: [conversationId], references: [id])
  events              LeadEvent[]
  sale                Sale?
  
  @@index([customerPhone])
  @@index([status])
  @@index([capturedAt])
  @@index([vehicleId])
  @@index([dealershipId])
}

// Eventos de timeline do Lead
model LeadEvent {
  id            String   @id @default(uuid())
  leadId        String
  eventType     String   // "created" | "status_changed" | "note_added"
  previousValue String?
  newValue      String?
  userId        String?
  timestamp     DateTime @default(now())
  
  // Relations
  lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id])
  
  @@index([leadId])
  @@index([timestamp])
}

// Registro de venda para tracking de comissões
model Sale {
  id               String    @id @default(uuid())
  leadId           String    @unique
  saleValue        Float                              // Valor final da venda
  commissionRate   Float                              // Rate at time of conversion
  commissionType   String                             // Type at time of conversion
  commissionAmount Float                              // Calculated commission
  isPaid           Boolean   @default(false)          // Commission paid to partner
  paidAt           DateTime?
  createdAt        DateTime  @default(now())
  
  // Relations
  lead             Lead      @relation(fields: [leadId], references: [id])
  
  @@index([isPaid])
  @@index([createdAt])
}

// Mensagens (log opcional)
model Message {
  id              String   @id @default(uuid())
  conversationId  String
  
  direction       String   // incoming, outgoing
  content         String
  messageType     String   @default("text") // text, image, button, audio
  
  // Audio message metadata (JSON: { duration, fileSize, transcription, transcribedAt })
  audioMetadata   Json?
  
  // WhatsApp metadata
  waMessageId     String?
  
  timestamp       DateTime @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([timestamp])
}
